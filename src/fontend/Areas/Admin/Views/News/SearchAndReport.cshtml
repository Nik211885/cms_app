@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    ViewData["Title"] = "Bài viết";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";

}


<div class="content container-fluid">
    <div class="card">
        <div class="content container-fluid">
            <div class="contact-profile">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <h3 class="page-title">Tra cứu và báo cáo</h3>
                        <ul class="breadcrumb">
                            <li class="breadcrumb-item"><a href="">Trang chủ</a></li>
                            <li class="breadcrumb-item active">Bài viết</li>
                        </ul>
                    </div>
                    <div class="col-md-8 float-end ms-auto">
                    </div>
                </div>
            </div>
        </div>
    </div>
    @* Tableeeeeeeeeeeeeeeeeeeeeeee *@
    <div class="card" style="margin-top: -8px;">
        <div class="content container-fluid">
            <div class="row filter-row">
                <div class="col-sm-6 col-md-3 col-lg-3 col-xl-2 col-12">
                    <div class="input-block mb-3 form-focus">
                        <input type="text" id="searchTitle" class="form-control floating" />
                        <label class="focus-label">Tên bài viết</label>
                    </div>
                </div>
              
                 <div class="col-sm-6 col-md-3 col-lg-3 col-xl-2 col-12">
                    <div class="input-block mb-3 form-focus select-focus focused">
                        <select id="statusSelect"  name="trangThai" class="select floating select2-hidden-accessible" data-select2-id="select2-data-4-dijy" tabindex="-1" aria-hidden="true">
                            <option value="">---Lựa chọn---</option>
                            <option value="true">Xuất bản</option>
                            <option value="false">Ngừng xuất bản</option>
                        </select>
                       
                        <label class="focus-label">Trình trạng</label>
                    </div>
                </div>
                <div class="col-sm-6 col-md-3 col-lg-3 col-xl-2 col-12">
                    <div class="input-block mb-3 form-focus focused">
                        <div class="">
                            
                            <input type="date" id="startDate" class="form-control" placeholder="Ngày bắt đầu" />
                        </div>
                        <label class="focus-label">From</label>
                    </div>
                </div>
                <div class="col-sm-6 col-md-3 col-lg-3 col-xl-2 col-12">
                    <div class="input-block mb-3 form-focus focused">
                        <div class="">
                            <input type="date" id="endDate" class="form-control" placeholder="Ngày kết thúc" />
                        </div>
                        <label class="focus-label">To</label>
                    </div>
                </div>
               <div class="col-sm-6 col-md-3 col-lg-3 col-xl-2 col-12">
                    <a id="filter-btn" href="#" class="btn btn-primary px-5 fw-bold" > Lọc </a>
                </div>
            </div>


                
            <div class="row">
                <div class="col-md-12">
                    <div class="table-responsive">
                        <table id="myTable" class="table table-striped table-bordered fw-bold" style="width:100%">
                            <thead class="thead-dark">
                                <tr>
                                    <th>STT</th>
                                    <th>Nhan đề</th>
                                    <th>Mô tả ngắn</th>
                                    <th>Ngày tạo</th>
                                    <th>Trạng thái</th>
                                    <th>Tình trạng</th>
                                    <th>Hành động</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div style="z-index:1000" data-bs-backdrop="dynamic" class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content" style="margin-top:-100px">
            <form id="addForm" method="post">
                <div class="modal-header row">
                    <div class="col-md-8">
                        <h5 class="modal-title" id="addModalLabel" style="font-size:20px">Thêm dịch vụ</h5>
                    </div>
                    <div class="col-md-4 float-end ms-auto">
                        <div class="d-flex title-head">
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="col-sm-12 mb-3">
                        <label class="form-label"><b>Tên dịch vụ</b> <span style="color:red">*</span></label>
                        <div class="input-group ">
                            <span class="input-group-text"><i class="las la-font"></i></span>
                            <input type="text" class="form-control form-control-sm" id="name" name="name" placeholder="Nhập tên dịch vụ" required />
                        </div>
                    </div>

                    <div class="col-sm-12 mb-3">
                        <label class="form-label"><b>Dịch vụ cha </b></label>
                        <div class="input-group ">
                            <span class="input-group-text"><i class="las la-bars"></i></span>
                            <select class="form-control form-control-sm" id="parent_id" name="parent_id">
                                <option selected value="0">Chọn dịch vụ cha</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-sm-12 mb-3">
                        <label class="form-label"><b>Thứ tự </b><span style="color:red">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="las la-list-ol"></i></span>
                            <input type="number" class="form-control form-control-sm" id="order_index" name="order_index" placeholder="Nhập thứ tự" required />
                        </div>
                    </div>

                </div>

                <div class="modal-footer">
                    <button id="btn-submit-add" data-dismiss="modal" type="button" class="btn btn-primary btn-sm"><i class="far fa-save fa-sm"></i>  Lưu</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div style="z-index:1000" data-bs-backdrop="dynamic" class="modal fade" id="addModal2" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content" style="margin-top:-100px">
            <form id="addForm" method="post">
                <div class="modal-header row">
                    <div class="col-md-8">
                        <h5 class="modal-title" id="addModalLabel" style="font-size:20px">Cập nhật dịch vụ</h5>
                    </div>
                    <div class="col-md-4 float-end ms-auto">
                        <div class="d-flex title-head">
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="col-sm-12 mb-3">
                        <label class="form-label"><b>Tên dịch vụ</b> <span style="color:red">*</span></label>
                        <div class="input-group ">
                            <span class="input-group-text"><i class="las la-font"></i></span>
                            <input type="text" class="form-control form-control-sm" id="name" name="name" placeholder="Nhập tên dịch vụ" required />
                        </div>
                    </div>

                    <div class="col-sm-12 mb-3">
                        <label class="form-label"><b>Dịch vụ cha </b></label>
                        <div class="input-group ">
                            <span class="input-group-text"><i class="las la-bars"></i></span>
                            <select class="form-control form-control-sm" id="parent_id" name="parent_id">
                                <option selected value="0">Chọn dịch vụ cha</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-sm-12 mb-3">
                        <label class="form-label"><b>Thứ tự </b><span style="color:red">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="las la-list-ol"></i></span>
                            <input type="number" class="form-control form-control-sm" id="order_index" name="order_index" placeholder="Nhập thứ tự" required />
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button id="btn-submit-add" data-dismiss="modal" type="button" class="btn btn-primary btn-sm"><i class="far fa-save fa-sm"></i>  Lưu</button>
                </div>
            </form>
        </div>
    </div>
</div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function() {
     var table = $('#myTable').DataTable({
                ajax: {
                    url: 'http://localhost:3001/danhsachbaiviet', // Đường dẫn đến file JSON
                    dataSrc: 'data.data' // Cập nhật để lấy dữ liệu từ `data.data`
                },
                columns: [
                    {
                        data: null, // Tính số thứ tự
                        render: function(data, type, row, meta) {
                            return meta.row + meta.settings._iDisplayStart + 1; // Tính số thứ tự
                        }
                    },
                    { data: 'title' },
                    {
                        data: 'news_description',
                        render: function(data) {
                            return data || '';
                        }
                    },
                    {
                        data: 'create_at',
                        render: function(data) {
                            if (!data) return '';
                            var date = new Date(data);
                            if (isNaN(date.getTime())) return '';
                            // Định dạng ngày theo dd/mm/yyyy
                            return date.toLocaleDateString('vi-VN', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric'
                            });
                        }
                    },
                    {
                        data: 'status_now.status',
                        render: function(data) {
                            let color, borderColor, statusText;
                            switch (data) {
                                case 0:
                                    color = 'text-warning'; 
                                    borderColor = 'border-warning';
                                    statusText = 'Chưa hoàn thành'; 
                                    break;
                                case 1:
                                    color = 'text-secondary'; 
                                    borderColor = 'border-secondary';
                                    statusText = 'Chờ duyệt'; 
                                    break;
                                case 2:
                                    color = 'text-success'; 
                                    borderColor = 'border-success';
                                    statusText = 'Duyệt thành công'; 
                                    break;
                                case 3:
                                    color = 'text-danger'; 
                                    borderColor = 'border-danger';
                                    statusText = 'Từ chối'; 
                                    break;
                                default:
                                    color = 'text-secondary'; 
                                    borderColor = 'border-secondary';
                                    statusText = 'Chưa xác định'; 
                            }
                            return `<div class="d-flex align-items-center ${color} p-1 border ${borderColor} rounded fw-bold">
                                        <i style="font-size: 5px !important;" class="fa-solid fa-circle px-1"></i>
                                        <span>${statusText}</span>
                                    </div>`;
                        }
                    },
                    {
                        data: 'status_now.active',
                        render: function(data) {
                            let color, borderColor, statusText;
                            switch (data) {
                                case true: 
                                    color = 'text-white'; 
                                    borderColor = 'bg-success';
                                    statusText = 'Xuất bản'; 
                                    break;
                                case false: 
                                    color = 'text-white'; 
                                    borderColor = 'bg-danger';
                                    statusText = 'Ngừng xuất bản'; 
                                    break;
                                default:
                                    color = 'text-secondary'; 
                                    borderColor = 'border-secondary';
                                    statusText = 'Chưa xác định'; 
                            }
                            return `<div class="d-flex align-items-center ${color} p-1 border ${borderColor} rounded fw-bold">
                                        <span>${statusText}</span>
                                    </div>`;
                        }
                    },
                    {
                        data: null,
                        className: 'text-center',
                        render: function(data, type, row) {
                            return `
                                <div class="dropdown">
                                    <button class="" type="button" id="actionMenu" data-bs-toggle="dropdown" aria-expanded="false" style="border:none;background-color:inherit">
                                        <i class="fa-solid fa-ellipsis-vertical fs-5" style="color: #000000;"></i>
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="actionMenu">
                                        <li class="d-flex align-items-center"><a class="dropdown-item btn-edit" data-id="${row.id}"><i class="fa-solid fa-pen mx-1" style="color: #0c0d0d;"></i>Chi tiết</a></li>
                                    </ul>
                                </div>
                            `;
                        }
                    }
                ]
            });

            // Sự kiện click cho nút lọc
            $('#filter-btn').on('click', function() {
                var searchTitle = $('#searchTitle').val().toLowerCase();
                var startDate = $('#startDate').val() ? new Date($('#startDate').val()) : null;
                var endDate = $('#endDate').val() ? new Date($('#endDate').val()) : null;
                var statusFilter = $('#statusSelect').val(); // Lấy giá trị select trạng thái

                table.rows().every(function() {
                    var data = this.data();
                    var isActive = data.status_now.active === true;
                    var matchesTitle = data.title.toLowerCase().includes(searchTitle);
                    
                    // Chuyển đổi ngày tạo từ chuỗi thành đối tượng Date
                    var createDate = new Date(data.create_at);
                    var isDateInRange = true;

                    // Kiểm tra ngày bắt đầu và kết thúc
                    if (startDate && createDate < startDate) {
                        isDateInRange = false; // Ngày tạo nhỏ hơn ngày bắt đầu
                    }
                    if (endDate && createDate > endDate) {
                        isDateInRange = false; // Ngày tạo lớn hơn ngày kết thúc
                    }

                    // Kiểm tra trạng thái
                    var matchesStatus = true;
                    if (statusFilter !== "") {
                        matchesStatus = (statusFilter === 'true' && isActive) || (statusFilter === 'false' && !isActive);
                    }

                    // Hiện/ẩn hàng dựa trên các điều kiện lọc
                    if (matchesTitle && isDateInRange && matchesStatus) {
                        $(this.node()).show();
                    } else {
                        $(this.node()).hide();
                    }
                });
                table.draw(); // Vẽ lại bảng
            });


 $('#myTable').on('click', '.btn-edit', function() {
    var id = $(this).data('id');
    // Chuyển hướng đến trang edit với ID của item, sử dụng URL tương đối
    window.location.href = `/admin/news/edit/${id}`;
});

});

</script>



