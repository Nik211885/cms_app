@{
    ViewData["Title"] = "Chỉnh sửa";
        Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";

}

<div class="content container-fluid">
    <div id="successMessage" class="bg-success px-2 rounded my-2 text-center text-white " style="display: none;">
    Gửi duyệt thành công
</div>
<div class="content container-fluid">
    <div id="saveSuccessMessage" class="bg-secondary px-2 rounded my-2 text-center text-white " style="display: none;">
    Lưu lại thành công
</div>
<div class="content container-fluid">
    <div class="card">
        <div class="content container-fluid">
            <div class="contact-profile">
                <div class="row align-items-center">
                       <div class="col-md-4">
                        <h3 class="page-title">Chỉnh sửa bài viết</h3>
                        <ul class="breadcrumb">
                            <li class="breadcrumb-item"><a href="">Trang chủ</a></li>
                            <li class="breadcrumb-item active">Bài viết</li>
                        </ul>
                    </div>
                    <div class="col-md-8 float-end ms-auto">
                        <div class="d-flex title-head">
                            @* <a href="/admin/servicesnews/create" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addModal"><i class="la la-plus-circle"></i>  Thêm mới</a> *@
                            <button id="saveNews" type="submit" class=" btn   btn-sm bg-secondary text-white"><i class="far fa-save fa-sm"></i> Lưu</button>
                          <button  id="postNews" class="btn btn-primary btn-sm mx-2" ><i class="la la-plus-circle"></i>  Gửi duyệt</button>
                      

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <form id="form-add-post" method="post">
        <div class="card" style="margin-top: -8px;">
            <div class="content container-fluid">
                 <div class="row ms-auto float-end py-2">
                    <div class="">
                    <button href="/admin/servicesnews/create"  id="saveServicesNews" class=" btn   btn-sm bg-warning text-white" > <i class="fa-solid fa-floppy-disk"></i> Lưu bản nháp</button>
                    </div>

                </div>
                <div class="row">
                    
                    <input type="hidden" id="add-id" name="id"/>
                    <div class="col-sm-12 mb-3">
                      <label for="parent-select class=""><b>Nhóm bài viết</b> <span style="color:red">*</span></label>
                        <select id="parent-select" class="border border-light-subtle rounded py-2" style="width: 100%;">
                            <option value="">--Nhóm bài viết--</option>
                            <option value="">--Tuyển dụng--</option>
                            <option value="">--Mời thầu--</option>


                        </select>
                        <div class="error-message text-danger text-sm mt-1 " id="error-cer_code"></div>
                    </div>

                    <div class="col-sm-12 mb-3">
                        <label class="form-label"><b>Nhan đề </b><span style="color:red">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="las la-font"></i></span>
                            <input type="text" class="form-control form-control-sm" id="title" name="title" placeholder="Nhập nhan đề"  />
                        </div>
                        <div class="error-message text-danger text-sm mt-1" id="error-title"></div>
                    </div>
                  
                    <div class="col-sm-12 mb-3">
                        <label class="form-label"><b>Nguồn</b> <span style="color:red">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="las la-link"></i></span>
                            <input type="text" class="form-control form-control-sm" id="source" name="source" placeholder="Nhập nguồn" />
                        </div>
                    </div>



                    <div class="col-sm-12 mb-3">
                        <label class="form-label"><b>Ảnh mô tả</b> (Kích thước ảnh 260 x 153)<span style="color:red"> *</span></label>
                        <div class="input-group">
                            <input name="avatar" type="file" id="avatar" class="form-control form-control-sm"
                                   onchange="validate()" accept="image/*"  />
                        </div>
                        <div class="error-message text-danger text-sm mt-1" id="error-avatar"></div>
                    </div>

                    <div id="preview-image-container " class="form-group col-md-12 d-flex justify-content-center mt-4">
                        <img id="avatar-input" class="rounded-3 shadow" title="Nhấn để điều chỉnh và cắt ảnh"
                             style="object-fit: contain; width: 220px; height: 150px; cursor: pointer" src="/img/defautAvatar.jpg" />
                    </div>
                   
                    

                    <div class="col-sm-12 mb-3">
                        <div class="form-group">
                            <label class="form-label"><b>Mô tả ngắn</b> <span style="color:red">*</span></label>
                            <textarea class="form-control form-control-sm" id="describle_short" name="describle_short" ></textarea>
                        </div>
                        <div class="error-message text-danger text-sm mt-2" id="error-describle_short"></div>
                    </div>

                    <div class="col-sm-12 mb-3">
                        <div class="form-group">
							<label class="form-label"><b>Nội dung</b> <span style="color:red">*</span></label>
                            <textarea class="form-control form-control-sm" id="content" name="content" ></textarea>
                        </div>
                        <div class="error-message text-danger text-sm mt-2" id="error-content"></div>
                    </div>
                  

                    <div class="col-sm-12 ml-4 mt-1 mb-3 d-flex">
                        <div class="col-sm-2">
                            <label class="form-label"><b>Tác vụ : </b></label>
                        </div>
                        <div>
                            <input class="form-check-input" type="checkbox" id="is_hightlight">
                            <label class="form-check-label" for="is_hightlight">
                                Nổi bật
                            </label>
                        </div>
                    </div>
                </div>
                 </div>
           

            

            <div class="card-footer">
                <div class="d-flex justify-content-end mt-1 mb-1">
                </div>
            </div>
        </div>
    </form>
</div>
<script src="~/js/jquery-3.7.1.min.js"></script>



<script>




    function getIdFromUrl() {
    const pathArray = window.location.pathname.split('/');
    return pathArray[pathArray.length - 1]; // Lấy ID từ đoạn cuối của URL
}
    $(document).ready(function () {
        
 $('#describle_short').summernote({
            toolbar: [
                ['style', ['bold', 'italic', 'underline', 'clear']],
                ['fontname', ['fontname']],
                ['fontsize', ['fontsize']],
                ['color', ['color']],
                ['height', ['height']],
            ],
            height: 100,
            fontSizes: ['8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '20', '24', '36'],
        });

          $('#content').summernote({
      toolbar: [
          ['style', ['bold', 'italic', 'underline', 'clear']],
          ['fontname', ['fontname']],
          ['fontsize', ['fontsize']],
          ['color', ['color']],
          ['para', ['ul', 'ol', 'paragraph']],
          ['height', ['height']],
          ['insert', ['picture', 'link', 'video', 'table', 'hr']],
          ['view', ['fullscreen', 'codeview', 'help']]
      ],
      height: 300,
      fontSizes: ['8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '20', '24', '36'],
  });

        
let childItem,IDselected;


   function getChildMenu(childItem, childId) {
    // Tìm danh mục con có id là childId
    const child = childItem.find(item => item.id == childId);
    const childSelect = $('#child-select');
        childSelect.empty(); 
    // Kiểm tra xem child có tồn tại và có chứa menu_child không
    if (child && Array.isArray(child.menu_child)) {
        console.log(child.menu_child); // Kiểm tra danh mục con của child
        
        // Xóa các tùy chọn cũ của #child-select
        

        // Lấy danh sách tùy chọn con và thêm vào child-select
        child.menu_child.forEach(function(value) {
            childSelect.append(new Option(value.name, value.id));
        });

        // Cập nhật lại Select2 cho danh mục con (nếu bạn sử dụng Select2)
        childSelect.trigger('change');
    } else {
        console.error(`Không tìm thấy danh mục con với id ${childId} hoặc không có danh mục con`);
    }
}



// Gọi API để lấy danh mục cha và danh mục con
        $.ajax({
            url: 'https://localhost:7052/api/menu/type?getChild=true',
            method: 'GET',
            dataType: 'json',
            success: function(data) {
                // Tìm danh mục có id là 45
                const parentItem = data.data.find(item => item.id === 45);

                if (parentItem && Array.isArray(parentItem.menu_child)) {
                    childItem = parentItem.menu_child;
                    console.log("Danh mục con của danh mục 45: ", childItem);

                    // Thêm danh mục cha vào #parent-select
                    childItem.forEach(function(value) {
                        $('#parent-select').append(new Option(value.name, value.id));
                    });
                } else {
                    console.error("Không tìm thấy danh mục có id 45 hoặc không có danh mục con");
                }
            },
            error: function(error) {
                console.error("Lỗi khi lấy dữ liệu từ API: ", error);
            }
        });

        // Xử lý sự kiện thay đổi của #parent-select

        $('#parent-select').on('change', function(e) {

            IDselected=e.target.value;
            // Gọi hàm getChildMenu với childItem và id của danh mục con cần lấy (ví dụ: 60)
            getChildMenu(childItem, e.target.value);
                console.log("sau khi chọn cha",IDselected)
        });

        $('#child-select').on('change', function(e) {
            IDselected=e.target.value;
            console.log("sau khi chọn con",IDselected)
        });




        function initializeSummernote(selector) {
            $(selector).summernote({
                   toolbar: [
                    ['style', ['bold', 'italic', 'underline', 'clear', 'strikethrough', 'superscript', 'subscript']],
                    ['font', ['fontname', 'fontsize', 'forecolor', 'backcolor']],
                    ['color', ['color']],
                    ['para', ['ul', 'ol', 'paragraph', 'alignleft', 'aligncenter', 'alignright', 'alignjustify']],
                    ['height', ['height']],
                    ['insert', ['picture', 'link', 'video', 'table', 'hr']],
                    ['view', ['fullscreen', 'codeview', 'help']],
                    ['misc', ['undo', 'redo']] // Thêm các tùy chọn Undo, Redo
                ],
                height: 300, // Chiều cao của khung soạn thảo
                fontSizes: ['8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '20', '24', '36'], // Tùy chỉnh kích thước font chữ
                fontNames: ['Arial', 'Arial Black', 'Comic Sans MS', 'Courier New', 'Merriweather', 'Georgia'], // Tùy chỉnh danh sách font chữ
                colors: [
                    ['#ff0000', '#00ff00', '#0000ff', '#000000', '#ffffff'], // Tùy chỉnh bảng màu
                    ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5']
                ]
            });
        }
    
        // Khởi tạo các editor Summernote hiện có
        for (let i = 1; i <= 4; i++) {
            initializeSummernote(`#contentServices${i}`);
        }
    
        let serviceCount = 4;  // Số lượng dịch vụ ban đầu
    

    // Fetching service news based on ID
   // Fetch dữ liệu từ server
var id = getIdFromUrl();
fetch(`https://localhost:7052/api/manager-news/news-services/detail?newsId=${id}`)
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        const newsData = data.data; // Truy cập vào trường "data" trong JSON

        

        // Điền tiêu đề và chỉ mục
        $('#servicesNewTitle').val(newsData.title); // Tiêu đề bài viết
        $('#orderIndex').val(newsData.views); // Ví dụ: sử dụng views làm chỉ số

        // Lấy parentId từ newsData
    

        // Xử lý các tab nội dung
        const tabContainer = $('#myTab');
        const tabContentContainer = $('#myTabContent');
        tabContainer.empty();
        tabContentContainer.empty();

        if (Array.isArray(newsData.content)) {
            newsData.content.forEach((item, index) => {
                const tabId = `tab${index + 1}`;
                tabContainer.append(`
                    <li class="nav-item" role="presentation">
                        <button class="nav-link ${index === 0 ? 'active' : ''} text-dark fw-bold" id="${tabId}-tab" data-bs-toggle="tab" data-bs-target="#${tabId}" type="button" role="tab" aria-controls="${tabId}" aria-selected="${index === 0}">${item.title}</button>
                    </li>
                `);

                tabContentContainer.append(`
                    <div class="tab-pane fade ${index === 0 ? 'show active' : ''}" id="${tabId}" role="tabpanel" aria-labelledby="${tabId}-tab">
                        <div class="form-group">
                            <label class="form-label"><b>Nội dung</b> <span style="color:red">*</span></label>
                            <textarea class="form-control form-control-sm summernote" id="contentServices${index + 1}" name="content"></textarea>
                        </div>
                    </div>
                `);

                // Khởi tạo Summernote cho từng nội dung
                initializeSummernote(`#contentServices${index + 1}`);
            });

            // Thiết lập nội dung cho từng Summernote
            newsData.content.forEach((item, index) => {
                $(`#contentServices${index + 1}`).summernote('code', item.content_html); // Đặt nội dung cho từng summernote
            });
        }


        @* Chọn menu từ dữ liệu  *@
        let targetId = newsData.menu[0].id;
        let isParentFound = false;
        let selectedParentId = null;

        // Tìm và chọn dịch vụ cha hoặc con
        childItem.forEach(service => {
            if (service.id === targetId) {
                // Nếu tìm thấy id ở dịch vụ cha
                selectedParentId = service.id;
                isParentFound = true;

                // Chọn dịch vụ cha và kích hoạt sự kiện onchange
                $('#parent-select').val(selectedParentId).trigger('change');
            } else if (service.menu_child) {
                // Nếu có dịch vụ con, kiểm tra trong các dịch vụ con
                service.menu_child.forEach(child => {
                    if (child.id === targetId) {
                        // Nếu tìm thấy id ở dịch vụ con
                        selectedParentId = service.id;

                        // Chọn dịch vụ cha và kích hoạt sự kiện onchange
                        $('#parent-select').val(selectedParentId).trigger('change');

                        // Chọn dịch vụ con
                        $('#child-select').val(targetId);
                    }
                });
            }
        });

        // Nếu không tìm thấy id trong cha hoặc con
        if (!selectedParentId) {
            console.log('Không tìm thấy dịch vụ với ID: ' + targetId);
        }


        if (selectedParentId) {
            // Chọn dịch vụ cha
            $('#parent-select').val(selectedParentId);
        } else {
            console.log('Không tìm thấy dịch vụ với ID: ' + targetId);
        }

        @* Ngày tạo *@

        let createAtValue = newsData.create_at;
        let formattedDate = new Date(createAtValue).toLocaleDateString('vi-VN');
            
         $('#create_at').text(formattedDate);


        @* Trạng thái *@
        let status = newsData.status;
        console.log(status)
        if(status==0){
            $('#status').text('Nháp')

        }
        else if(status==1){
            $('#status').text('Chờ duyệt')
            console.log('ok 1')

        }
        else if(status==3){
            $('#status').text('Từ chối')

        }

        @* Tác vụ *@
        let significant = newsData.significant;

        if (significant === true) {
            $('#is_hightlight').prop('checked', true); // Tick checkbox
        } else {
            $('#is_hightlight').prop('checked', false); // Uncheck checkbox
        }



        $('#postServicesNews').on('click', function(event) {
    event.preventDefault();

    // Kiểm tra điều kiện đầu vào
    const is_hightlight = $('#is_hightlight').is(':checked');
    if (!targetId) {
        alert('Vui lòng điền đầy đủ các trường cần thiết!');
        return;
    }

    // Khởi tạo formData theo cấu trúc JSON yêu cầu
    let formData = {
        significant: is_hightlight,
        news_content: [],
        status: 1, // Thay đổi giá trị status nếu cần
        status_message: "", // Thêm thông điệp nếu cần

        menu_id: [targetId]
    };

    // Duyệt qua các dịch vụ
    $('.nav-tabs li').each(function(index) {
        // Lấy tên của tab (nội dung của nút button)
        const serviceName = $(this).find('.nav-link').text(); 

        // Lấy nội dung từ Summernote
        const contentHtml = $(`#contentServices${index + 1}`).summernote('code'); 

        // Đẩy dữ liệu vào mảng formData.news_content
        formData.news_content.push({
            id: index, // Thêm id nếu cần
            content_html: contentHtml,
            title: serviceName
        });
    });

    console.log(formData);

    fetch(`https://localhost:7052/api/manager-news/update-news-services?newsId=${newsData.id}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        // Kiểm tra mã trạng thái HTTP
        if (!response.ok) {
            return response.json().then(errData => {
                throw new Error(errData.message || 'Đã xảy ra lỗi');
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('Dữ liệu đã được gửi thành công:', data);
        alert(data.message || 'Dữ liệu đã được gửi thành công!'); // Hiện thông báo từ server
    })
    .catch(error => {
        console.error('Lỗi khi gửi dữ liệu:', error);
        alert('Lỗi: ' + error.message); // Hiện thông báo lỗi
    });
});

$('#saveServicesNews').on('click', function(event) {
    event.preventDefault();

    // Kiểm tra điều kiện đầu vào
    const is_hightlight = $('#is_hightlight').is(':checked');
    if (!targetId) {
        alert('Vui lòng điền đầy đủ các trường cần thiết!');
        return;
    }

    // Khởi tạo formData theo cấu trúc JSON yêu cầu
    let formData = {
        significant: is_hightlight,
        news_content: [],
        status: 0, // Thay đổi giá trị status nếu cần
        status_message: "", // Thêm thông điệp nếu cần

        menu_id: [targetId]
    };

    // Duyệt qua các dịch vụ
    $('.nav-tabs li').each(function(index) {
        // Lấy tên của tab (nội dung của nút button)
        const serviceName = $(this).find('.nav-link').text(); 

        // Lấy nội dung từ Summernote
        const contentHtml = $(`#contentServices${index + 1}`).summernote('code'); 

        // Đẩy dữ liệu vào mảng formData.news_content
        formData.news_content.push({
            id: index, // Thêm id nếu cần
            content_html: contentHtml,
            title: serviceName
        });
    });

    console.log(formData);

    fetch(`https://localhost:7052/api/manager-news/update-news-services?newsId=${newsData.id}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        // Kiểm tra mã trạng thái HTTP
        if (!response.ok) {
            return response.json().then(errData => {
                throw new Error(errData.message || 'Đã xảy ra lỗi');
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('Dữ liệu đã được gửi thành công:', data);
        alert(data.message || 'Dữ liệu đã được gửi thành công!'); // Hiện thông báo từ server
    })
    .catch(error => {
        console.error('Lỗi khi gửi dữ liệu:', error);
        alert('Lỗi: ' + error.message); // Hiện thông báo lỗi
    });
});

    })
    .catch(error => console.error('Lỗi:', error));



    
  
    function initializeSummernote(selector) {
        $(selector).summernote({
            toolbar: [
                ['style', ['bold', 'italic', 'underline', 'clear']],
                ['fontname', ['fontname']],
                ['fontsize', ['fontsize']],
                ['color', ['color']],
                ['para', ['ul', 'ol', 'paragraph']],
                ['height', ['height']],
                ['insert', ['picture', 'link', 'video', 'table', 'hr']],
                ['view', ['fullscreen', 'codeview', 'help']]
            ],
            height: 300,
            fontSizes: ['8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '20', '24', '36'],
        });
    }
});

</script>



